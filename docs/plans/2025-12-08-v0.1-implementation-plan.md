# VaultClip v0.1 Prototype Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to
> implement this plan task-by-task.

**Goal:** Build a working encrypted clipboard manager with global hotkey
access - validates core security value proposition

**Architecture:** Single-file Swift prototype using CryptoKit (AES-256-GCM),
SwiftUI, Carbon hotkeys, in-memory storage

**Tech Stack:** Swift 5.9+, SwiftUI, CryptoKit, AppKit, Carbon.HIToolbox,
Xcode 15+

---

## Task 1: Create Xcode Project

**Files:**

- Create: `VaultClip.xcodeproj/`
- Create: `VaultClip/`
- Create: `VaultClipTests/`

### Step 1: Create macOS App project

```bash
# Open Xcode
open -a Xcode

# Create new project:
# - macOS â†’ App
# - Product Name: VaultClip
# - Organization Identifier: com.airshiplabs
# - Interface: SwiftUI
# - Language: Swift
# - Use Core Data: NO
# - Include Tests: YES
```

### Step 2: Configure project settings

In Xcode project navigator:

1. Select VaultClip target
2. General tab:
   - Deployment Target: macOS 12.0
   - Bundle Identifier: com.airshiplabs.vaultclip
3. Signing & Capabilities:
   - Enable "Automatically manage signing"
   - Select your development team
   - Add Capability: App Sandbox
   - Add Capability: Hardened Runtime
4. Build Settings:
   - Swift Language Version: Swift 5

### Step 3: Verify project builds

Run: Cmd+B (Build)
Expected: "Build Succeeded"

### Step 4: Commit project

```bash
git add VaultClip.xcodeproj/ VaultClip/ VaultClipTests/
git commit -m "feat: create Xcode project with macOS app target"
```

---

## Task 2: Configure Entitlements

**Files:**

- Create: `VaultClip/VaultClip.entitlements`

### Step 1: Create entitlements file

In Xcode:

1. File â†’ New â†’ File
2. Property List
3. Save as `VaultClip.entitlements` in VaultClip/ folder

### Step 2: Add sandbox entitlements

Add to VaultClip.entitlements:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.security.app-sandbox</key>
    <true/>
    <key>com.apple.security.application-groups</key>
    <array>
        <string>$(TeamIdentifierPrefix)com.airshiplabs.vaultclip</string>
    </array>
</dict>
</plist>
```

### Step 3: Link entitlements to target

In Xcode:

1. Select VaultClip target
2. Build Settings â†’ Search "entitlements"
3. Code Signing Entitlements: `VaultClip/VaultClip.entitlements`

### Step 4: Verify build still succeeds

Run: Cmd+B
Expected: "Build Succeeded"

### Step 5: Commit

```bash
git add VaultClip/VaultClip.entitlements VaultClip.xcodeproj/
git commit -m "feat: add sandbox entitlements configuration"
```

---

## Task 3: Write Encryption Security Tests (TDD)

**Files:**

- Create: `VaultClipTests/SecurityTests.swift`

### Step 1: Create test file

Create `VaultClipTests/SecurityTests.swift`:

```swift
import XCTest
import CryptoKit
@testable import VaultClip

class SecurityTests: XCTestCase {

    // CRITICAL TEST: Verify unique nonces per encryption
    func testEncryptionProducesUniqueNonces() throws {
        let encryption = ClipboardEncryption()
        let plaintext = "sensitive data"

        let encrypted1 = try encryption.encrypt(plaintext)
        let encrypted2 = try encryption.encrypt(plaintext)

        // Same plaintext MUST produce different ciphertext (unique nonces)
        XCTAssertNotEqual(encrypted1.ciphertext, encrypted2.ciphertext,
                         "Same plaintext should produce different " +
                         "ciphertext with unique nonces")
        XCTAssertNotEqual(encrypted1.nonce, encrypted2.nonce,
                         "Each encryption must use a unique nonce")
    }

    // CRITICAL TEST: Authenticated encryption detects tampering
    func testDecryptionFailsOnTamperedData() throws {
        let encryption = ClipboardEncryption()
        let plaintext = "sensitive data"

        var encrypted = try encryption.encrypt(plaintext)

        // Tamper with ciphertext (flip first byte)
        var tamperedCiphertext = encrypted.ciphertext
        tamperedCiphertext[0] ^= 0xFF
        encrypted.ciphertext = tamperedCiphertext

        // Decryption MUST fail when data is tampered
        XCTAssertThrowsError(try encryption.decrypt(encrypted)) { error in
            XCTAssertTrue(error is CryptoKitError,
                         "Should throw CryptoKitError on tampered data")
        }
    }

    // Test roundtrip encryption/decryption
    func testEncryptionDecryptionRoundtrip() throws {
        let encryption = ClipboardEncryption()
        let plaintext = "test clipboard content"

        let encrypted = try encryption.encrypt(plaintext)
        let decrypted = try encryption.decrypt(encrypted)

        XCTAssertEqual(plaintext, decrypted,
                      "Decrypted text should match original plaintext")
    }

    // Test various input sizes
    func testEncryptionWithVariousInputSizes() throws {
        let encryption = ClipboardEncryption()

        let testCases = [
            "a",                                    // Single char
            String(repeating: "x", count: 100),     // Small
            String(repeating: "y", count: 10_000),  // Large
            "Unicode: ä½ å¥½ä¸–ç•Œ ðŸ”"                   // Unicode
        ]

        for plaintext in testCases {
            let encrypted = try encryption.encrypt(plaintext)
            let decrypted = try encryption.decrypt(encrypted)
            XCTAssertEqual(plaintext, decrypted,
                          "Failed for input: \(plaintext.prefix(20))...")
        }
    }
}
```

### Step 2: Run tests to verify they fail

Run: Cmd+U (Run Tests)
Expected: ALL TESTS FAIL with "Use of unresolved identifier 'ClipboardEncryption'"

### Step 3: Commit failing tests

```bash
git add VaultClipTests/SecurityTests.swift
git commit -m "test: add encryption security tests (RED phase)"
```

---

## Task 4: Implement Encryption Data Structures

**Files:**

- Modify: `VaultClip/VaultClipApp.swift`

### Step 1: Add encryption data model

Add to top of `VaultClip/VaultClipApp.swift` (after imports):

```swift
import SwiftUI
import CryptoKit
import AppKit
import Carbon.HIToolbox
import Combine

// MARK: - Encryption Data Structures

struct EncryptedClipboardItem: Identifiable {
    let id: UUID
    let timestamp: Date
    let ciphertext: Data      // Encrypted text
    let nonce: Data           // AES.GCM.Nonce (12 bytes)
    let tag: Data             // Authentication tag (16 bytes)
}

enum EncryptionError: Error {
    case invalidInput
    case keyRetrievalFailed
    case encryptionFailed
    case decryptionFailed
    case corruptedData
}
```

### Step 2: Verify build

Run: Cmd+B
Expected: "Build Succeeded"

### Step 3: Run tests

Run: Cmd+U
Expected: Tests still fail (ClipboardEncryption class not implemented yet)

### Step 4: Commit

```bash
git add VaultClip/VaultClipApp.swift
git commit -m "feat: add encryption data structures"
```

---

## Task 5: Implement Keychain Manager

**Files:**

- Modify: `VaultClip/VaultClipApp.swift`

### Step 1: Add KeychainManager class

Add to `VaultClipApp.swift`:

```swift
// MARK: - Keychain Manager

class KeychainManager {
    private static let keyIdentifier = "com.airshiplabs.vaultclip.masterkey"

    enum KeychainError: Error {
        case storeFailed(OSStatus)
        case retrieveFailed(OSStatus)
        case deleteFailed(OSStatus)
    }

    static func getMasterKey() throws -> SymmetricKey {
        // Try to retrieve existing key
        if let existingKey = try? retrieveKey() {
            return existingKey
        }

        // Generate new key if none exists
        let newKey = SymmetricKey(size: .bits256)
        try storeKey(newKey)
        return newKey
    }

    private static func storeKey(_ key: SymmetricKey) throws {
        let keyData = key.withUnsafeBytes { Data($0) }

        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrAccount as String: keyIdentifier,
            kSecAttrAccessible as String: kSecAttrAccessibleWhenUnlockedThisDeviceOnly,
            kSecValueData as String: keyData
        ]

        let status = SecItemAdd(query as CFDictionary, nil)

        // Zero the key data
        zeroMemory(keyData)

        guard status == errSecSuccess else {
            throw KeychainError.storeFailed(status)
        }
    }

    private static func retrieveKey() throws -> SymmetricKey {
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrAccount as String: keyIdentifier,
            kSecReturnData as String: true
        ]

        var result: AnyObject?
        let status = SecItemCopyMatching(query as CFDictionary, &result)

        guard status == errSecSuccess,
              let keyData = result as? Data else {
            throw KeychainError.retrieveFailed(status)
        }

        let key = SymmetricKey(data: keyData)

        // Zero the key data
        zeroMemory(keyData)

        return key
    }

    // For testing: delete key
    static func deleteKey() throws {
        let query: [String: Any] = [
            kSecClass as String: kSecClassGenericPassword,
            kSecAttrAccount as String: keyIdentifier
        ]

        let status = SecItemDelete(query as CFDictionary)

        guard status == errSecSuccess || status == errSecItemNotFound else {
            throw KeychainError.deleteFailed(status)
        }
    }
}

// MARK: - Memory Protection

func zeroMemory(_ data: Data) {
    data.withUnsafeBytes { ptr in
        if let baseAddress = ptr.baseAddress {
            memset_s(UnsafeMutableRawPointer(mutating: baseAddress),
                    ptr.count, 0, ptr.count)
        }
    }
}

func zeroMemory(_ data: inout Data) {
    data.withUnsafeMutableBytes { ptr in
        if let baseAddress = ptr.baseAddress {
            memset_s(baseAddress, ptr.count, 0, ptr.count)
        }
    }
}
```

### Step 2: Verify build

Run: Cmd+B
Expected: "Build Succeeded"

### Step 3: Commit

```bash
git add VaultClip/VaultClipApp.swift
git commit -m "feat: implement Keychain master key storage with memory zeroing"
```

---

## Task 6: Implement ClipboardEncryption Class

**Files:**

- Modify: `VaultClip/VaultClipApp.swift`

### Step 1: Add ClipboardEncryption implementation

Add to `VaultClipApp.swift`:

```swift
// MARK: - Clipboard Encryption

class ClipboardEncryption {

    func encrypt(_ plaintext: String) throws -> EncryptedClipboardItem {
        // Validate input
        guard !plaintext.isEmpty else {
            throw EncryptionError.invalidInput
        }

        // Get master key from Keychain
        let key = try KeychainManager.getMasterKey()

        // Generate unique nonce (CRITICAL: never reuse)
        let nonce = AES.GCM.Nonce()

        // Convert string to Data
        guard let data = plaintext.data(using: .utf8) else {
            throw EncryptionError.invalidInput
        }

        // Encrypt with AES-256-GCM
        let sealedBox = try AES.GCM.seal(data, using: key, nonce: nonce)

        // Extract components
        return EncryptedClipboardItem(
            id: UUID(),
            timestamp: Date(),
            ciphertext: sealedBox.ciphertext,
            nonce: Data(sealedBox.nonce),
            tag: sealedBox.tag
        )
    }

    func decrypt(_ item: EncryptedClipboardItem) throws -> String {
        // Get master key
        let key = try KeychainManager.getMasterKey()

        // Reconstruct nonce
        guard let nonce = try? AES.GCM.Nonce(data: item.nonce) else {
            throw EncryptionError.corruptedData
        }

        // Reconstruct sealed box
        guard let sealedBox = try? AES.GCM.SealedBox(
            nonce: nonce,
            ciphertext: item.ciphertext,
            tag: item.tag
        ) else {
            throw EncryptionError.corruptedData
        }

        // Decrypt and verify authentication tag
        let decryptedData = try AES.GCM.open(sealedBox, using: key)

        // Convert to string
        guard let plaintext = String(data: decryptedData,
                                     encoding: .utf8) else {
            throw EncryptionError.corruptedData
        }

        // Zero the decrypted data
        defer {
            var mutableData = decryptedData
            zeroMemory(&mutableData)
        }

        return plaintext
    }
}
```

### Step 2: Run tests to verify they pass

Run: Cmd+U
Expected: ALL TESTS PASS (GREEN phase)

### Step 3: Commit

```bash
git add VaultClip/VaultClipApp.swift
git commit -m "feat: implement AES-256-GCM encryption with unique nonces \
(GREEN phase)"
```

---

## Task 7: Add Keychain Persistence Test

**Files:**

- Modify: `VaultClipTests/SecurityTests.swift`

### Step 1: Add Keychain test

Add to `SecurityTests.swift`:

```swift
    // Test Keychain integration
    func testKeychainMasterKeyPersistence() throws {
        // Clean slate
        try? KeychainManager.deleteKey()

        // First retrieval (generates key)
        let key1 = try KeychainManager.getMasterKey()

        // Second retrieval (should be same key)
        let key2 = try KeychainManager.getMasterKey()

        // Keys should be identical
        let data1 = key1.withUnsafeBytes { Data($0) }
        let data2 = key2.withUnsafeBytes { Data($0) }

        XCTAssertEqual(data1, data2,
                      "Retrieved key should match stored key")

        // Cleanup
        try KeychainManager.deleteKey()
    }
```

### Step 2: Run test

Run: Cmd+U
Expected: Test PASSES

### Step 3: Commit

```bash
git add VaultClipTests/SecurityTests.swift
git commit -m "test: add Keychain persistence verification"
```

---

## Task 8: Implement ClipboardMonitor

**Files:**

- Modify: `VaultClip/VaultClipApp.swift`

### Step 1: Add ClipboardMonitor class

Add to `VaultClipApp.swift`:

```swift
// MARK: - Clipboard Monitor

class ClipboardMonitor: ObservableObject {
    @Published var newClipboardText: String?

    private var timer: Timer?
    private var lastChangeCount: Int = 0
    private let pasteboard = NSPasteboard.general
    private let pollInterval: TimeInterval = 0.5  // 500ms

    func startMonitoring() {
        // Initialize with current state
        lastChangeCount = pasteboard.changeCount

        // Poll for changes
        timer = Timer.scheduledTimer(
            withTimeInterval: pollInterval,
            repeats: true
        ) { [weak self] _ in
            self?.checkForChanges()
        }
    }

    func stopMonitoring() {
        timer?.invalidate()
        timer = nil
    }

    private func checkForChanges() {
        let currentChangeCount = pasteboard.changeCount

        // Only process if change count increased
        guard currentChangeCount > lastChangeCount else { return }

        lastChangeCount = currentChangeCount

        // Extract plain text (safely)
        guard let text = pasteboard.string(forType: .string),
              !text.isEmpty else { return }

        // Validate input
        guard validateClipboardText(text) else { return }

        // Notify observers (will trigger encryption & storage)
        DispatchQueue.main.async {
            self.newClipboardText = text
        }
    }

    func validateClipboardText(_ text: String) -> Bool {
        // Basic validation
        guard text.count <= 1_000_000 else { return false }  // 1MB max
        guard text.utf16.count > 0 else { return false }     // Valid UTF-16
        return true
    }
}
```

### Step 2: Verify build

Run: Cmd+B
Expected: "Build Succeeded"

### Step 3: Commit

```bash
git add VaultClip/VaultClipApp.swift
git commit -m "feat: implement clipboard polling monitor"
```

---

## Task 9: Implement ClipboardStore

**Files:**

- Modify: `VaultClip/VaultClipApp.swift`

### Step 1: Add ClipboardStore class

Add to `VaultClipApp.swift`:

```swift
// MARK: - Clipboard Store

@MainActor
class ClipboardStore: ObservableObject {
    @Published var items: [EncryptedClipboardItem] = []

    private let maxItems = 100  // Limit for prototype
    private let encryption = ClipboardEncryption()

    func addClipboardText(_ plaintext: String) async {
        do {
            // Encrypt the text
            let encryptedItem = try encryption.encrypt(plaintext)

            // Add to history (newest first)
            items.insert(encryptedItem, at: 0)

            // Enforce limit
            if items.count > maxItems {
                items.removeLast()
            }

        } catch {
            // Safe to log errors (not content)
            print("Encryption failed: \(error)")
        }
    }

    func getDecryptedText(for item: EncryptedClipboardItem) -> String? {
        do {
            return try encryption.decrypt(item)
        } catch {
            print("Decryption failed: \(error)")
            return nil
        }
    }

    func pasteItem(_ item: EncryptedClipboardItem) {
        guard let plaintext = getDecryptedText(for: item) else { return }

        // Write to pasteboard
        let pasteboard = NSPasteboard.general
        pasteboard.clearContents()
        pasteboard.setString(plaintext, forType: .string)
    }

    func clearHistory() {
        items.removeAll()
    }
}
```

### Step 2: Verify build

Run: Cmd+B
Expected: "Build Succeeded"

### Step 3: Commit

```bash
git add VaultClip/VaultClipApp.swift
git commit -m "feat: implement in-memory encrypted clipboard store"
```

---

## Task 10: Implement HotkeyManager

**Files:**

- Modify: `VaultClip/VaultClipApp.swift`

### Step 1: Add HotkeyManager class

Add to `VaultClipApp.swift`:

```swift
// MARK: - Hotkey Manager

class HotkeyManager {
    private var hotKeyRef: EventHotKeyRef?
    private var eventHandler: EventHandlerRef?

    typealias HotkeyCallback = () -> Void
    private var callback: HotkeyCallback?

    func register(
        key: UInt32 = UInt32(kVK_ANSI_V),
        modifiers: UInt32 = UInt32(cmdKey | shiftKey),
        callback: @escaping HotkeyCallback
    ) {
        self.callback = callback

        var hotKeyID = EventHotKeyID()
        hotKeyID.signature = UTGetOSTypeFromString("VCLP" as CFString)
        hotKeyID.id = 1

        var eventType = EventTypeSpec()
        eventType.eventClass = OSType(kEventClassKeyboard)
        eventType.eventKind = OSType(kEventHotKeyPressed)

        InstallEventHandler(
            GetApplicationEventTarget(),
            { _, event, userData -> OSStatus in
                let manager = Unmanaged<HotkeyManager>
                    .fromOpaque(userData!)
                    .takeUnretainedValue()
                manager.callback?()
                return noErr
            },
            1,
            &eventType,
            Unmanaged.passUnretained(self).toOpaque(),
            &eventHandler
        )

        RegisterEventHotKey(
            key,
            modifiers,
            hotKeyID,
            GetApplicationEventTarget(),
            0,
            &hotKeyRef
        )
    }

    func unregister() {
        if let hotKeyRef = hotKeyRef {
            UnregisterEventHotKey(hotKeyRef)
        }
        if let eventHandler = eventHandler {
            RemoveEventHandler(eventHandler)
        }
    }
}
```

### Step 2: Verify build

Run: Cmd+B
Expected: "Build Succeeded"

### Step 3: Commit

```bash
git add VaultClip/VaultClipApp.swift
git commit -m "feat: implement global hotkey registration (Cmd+Shift+V)"
```

---

## Task 11: Implement SwiftUI Components

**Files:**

- Modify: `VaultClip/VaultClipApp.swift`

### Step 1: Add WindowState class

Add to `VaultClipApp.swift`:

```swift
// MARK: - Window State

class WindowState: ObservableObject {
    @Published var isVisible = false

    func toggleVisibility() {
        isVisible.toggle()

        if isVisible {
            // Bring window to front
            NSApp.activate(ignoringOtherApps: true)
        }
    }
}
```

### Step 2: Add SearchBar view

Add to `VaultClipApp.swift`:

```swift
// MARK: - UI Components

struct SearchBar: View {
    @Binding var text: String

    var body: some View {
        HStack {
            Image(systemName: "magnifyingglass")
                .foregroundColor(.secondary)
            TextField("Search clipboard...", text: $text)
                .textFieldStyle(.plain)
        }
        .padding(8)
        .background(Color.gray.opacity(0.1))
        .cornerRadius(8)
    }
}
```

### Step 3: Add ClipboardItemRow view

Add to `VaultClipApp.swift`:

```swift
struct ClipboardItemRow: View {
    let item: EncryptedClipboardItem
    let store: ClipboardStore
    let isSelected: Bool

    @State private var preview: String = "Decrypting..."

    var body: some View {
        HStack {
            VStack(alignment: .leading, spacing: 4) {
                Text(preview)
                    .lineLimit(2)
                    .font(.body)

                Text(item.timestamp, style: .relative)
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            Spacer()
        }
        .padding()
        .background(isSelected ? Color.accentColor.opacity(0.2) : Color.clear)
        .cornerRadius(8)
        .onAppear {
            loadPreview()
        }
    }

    private func loadPreview() {
        if let text = store.getDecryptedText(for: item) {
            // Show first 100 chars as preview
            preview = String(text.prefix(100))
        } else {
            preview = "[Decryption failed]"
        }
    }
}
```

### Step 4: Verify build

Run: Cmd+B
Expected: "Build Succeeded"

### Step 5: Commit

```bash
git add VaultClip/VaultClipApp.swift
git commit -m "feat: add SwiftUI components (SearchBar, ClipboardItemRow)"
```

---

## Task 12: Implement ContentView

**Files:**

- Modify: `VaultClip/VaultClipApp.swift`

### Step 1: Add ContentView

Add to `VaultClipApp.swift`:

```swift
// MARK: - Content View

struct ContentView: View {
    @ObservedObject var store: ClipboardStore
    @ObservedObject var windowState: WindowState

    @State private var selectedItem: EncryptedClipboardItem?
    @State private var searchText = ""

    var body: some View {
        VStack(spacing: 0) {
            // Search bar
            SearchBar(text: $searchText)
                .padding()

            // Clipboard history list
            ScrollView {
                LazyVStack(spacing: 8) {
                    ForEach(filteredItems) { item in
                        ClipboardItemRow(
                            item: item,
                            store: store,
                            isSelected: selectedItem?.id == item.id
                        )
                        .onTapGesture {
                            handleSelection(item)
                        }
                    }
                }
                .padding()
            }

            // Footer with stats
            HStack {
                Text("\(store.items.count) items")
                    .font(.caption)
                    .foregroundColor(.secondary)
                Spacer()
                Button("Clear All") {
                    store.clearHistory()
                }
                .buttonStyle(.borderless)
            }
            .padding()
        }
        .frame(width: 600, height: 400)
        .onAppear {
            NSApp.activate(ignoringOtherApps: true)
        }
    }

    private var filteredItems: [EncryptedClipboardItem] {
        // For v0.1, return all items (search not implemented)
        store.items
    }

    private func handleSelection(_ item: EncryptedClipboardItem) {
        store.pasteItem(item)
        windowState.isVisible = false
    }
}
```

### Step 2: Verify build

Run: Cmd+B
Expected: "Build Succeeded"

### Step 3: Commit

```bash
git add VaultClip/VaultClipApp.swift
git commit -m "feat: implement main ContentView with clipboard list"
```

---

## Task 13: Wire Up Main App

**Files:**

- Modify: `VaultClip/VaultClipApp.swift`

### Step 1: Implement VaultClipApp

Replace the existing `@main` struct with:

```swift
// MARK: - Main App

@main
struct VaultClipApp: App {
    @StateObject private var clipboardMonitor = ClipboardMonitor()
    @StateObject private var clipboardStore = ClipboardStore()
    @StateObject private var windowState = WindowState()

    private let hotkeyManager = HotkeyManager()
    private var cancellables = Set<AnyCancellable>()

    var body: some Scene {
        WindowGroup {
            ContentView(
                store: clipboardStore,
                windowState: windowState
            )
        }
        .windowStyle(.hiddenTitleBar)
        .windowResizability(.contentSize)
        .defaultSize(width: 600, height: 400)
    }

    init() {
        setupClipboardPipeline()
        setupHotkey()
        startMonitoring()
    }

    private func setupClipboardPipeline() {
        // Wire monitor to store
        clipboardMonitor.$newClipboardText
            .compactMap { $0 }
            .sink { [clipboardStore] text in
                Task {
                    await clipboardStore.addClipboardText(text)
                }
            }
            .store(in: &cancellables)
    }

    private func setupHotkey() {
        hotkeyManager.register { [windowState] in
            DispatchQueue.main.async {
                windowState.toggleVisibility()
            }
        }
    }

    private func startMonitoring() {
        clipboardMonitor.startMonitoring()
    }
}
```

### Step 2: Fix compilation errors

The `cancellables` property needs to be mutable. Update the struct:

```swift
@main
struct VaultClipApp: App {
    @StateObject private var clipboardMonitor = ClipboardMonitor()
    @StateObject private var clipboardStore = ClipboardStore()
    @StateObject private var windowState = WindowState()

    private let hotkeyManager = HotkeyManager()
    @State private var cancellables = Set<AnyCancellable>()

    // ... rest of implementation
}
```

### Step 3: Build and verify

Run: Cmd+B
Expected: "Build Succeeded"

### Step 4: Commit

```bash
git add VaultClip/VaultClipApp.swift
git commit -m "feat: wire up main app with monitorâ†’storeâ†’UI pipeline"
```

---

## Task 14: Manual Testing & Verification

**Files:**

- None (testing phase)

### Step 1: Run the app

Run: Cmd+R (Run)
Expected: App launches, no visible window initially

### Step 2: Test clipboard monitoring

1. Copy some text (Cmd+C in any app)
2. Wait 1 second
3. Press Cmd+Shift+V
4. Expected: Popup window appears with clipboard history

### Step 3: Test clipboard paste

1. With popup open, click on an item
2. Expected: Window closes, item is pasted to clipboard
3. Paste (Cmd+V) in another app to verify

### Step 4: Test keyboard navigation

1. Open popup (Cmd+Shift+V)
2. Press Escape
3. Expected: Window closes

### Step 5: Test Clear All

1. Open popup
2. Click "Clear All"
3. Expected: History cleared, list empty

### Step 6: Test encryption is working

Check that:

- No plaintext visible in memory dumps
- Items are being encrypted (check with debugger)
- Unique nonces per item

### Step 7: Document any issues

Create issues in bd for any bugs found:

```bash
bd create "Bug: [description]" --type bug --priority 0
```

---

## Task 15: Final Security Verification

**Files:**

- None (verification phase)

### Step 1: Run all tests

Run: Cmd+U
Expected: ALL TESTS PASS

### Step 2: Verify security properties

Check:

- [ ] Encryption uses unique nonces (verified by tests)
- [ ] Master key in Keychain (verified by tests)
- [ ] No plaintext logged to console
- [ ] Memory zeroing after decryption
- [ ] Input validation on clipboard data

### Step 3: Check for security anti-patterns

Search codebase:

```bash
# Check for banned APIs
grep -r "unarchiveObject" VaultClip/
grep -r "CCCrypt" VaultClip/
grep -r "print.*clipboard" VaultClip/

# Expected: No matches
```

### Step 4: Code signing verification

```bash
# Build for release
xcodebuild -scheme VaultClip -configuration Release

# Check code signing
codesign --verify --deep --strict build/Release/VaultClip.app
```

Expected: "satisfies its Designated Requirement"

### Step 5: Document completion

```bash
bd create "v0.1 Complete - Ready for User Testing" --type task --priority 1
```

---

## Task 16: Final Commit & Tag

**Files:**

- All

### Step 1: Final commit

```bash
git add -A
git commit -m "feat: VaultClip v0.1 prototype complete

- AES-256-GCM encrypted clipboard history
- Global hotkey (Cmd+Shift+V) popup UI
- In-memory storage (100 items max)
- Master key in Keychain
- All security tests passing

Ready for user testing and feedback."
```

### Step 2: Tag release

```bash
git tag -a v0.1.0 -m "VaultClip v0.1 - First Working Prototype

Core Features:
- Encrypted clipboard history (AES-256-GCM)
- Global hotkey access (Cmd+Shift+V)
- Plain text support
- In-memory storage

Security:
- Unique nonces per encryption
- Master key in Keychain
- Memory zeroing
- No plaintext logging

Limitations (documented):
- No persistence (history cleared on quit)
- Plain text only (no images/files)
- No authentication (Touch ID)
- Fixed hotkey
- Basic UI"

git push origin feature/v0.1-prototype
git push origin v0.1.0
```

### Step 3: Create completion summary

Document:

- What was built
- What was tested
- Known limitations
- Next steps (v0.2 features)

---

## Success Criteria Checklist

- [ ] Xcode project builds successfully
- [ ] All security tests pass (unique nonces, tampering detection, roundtrip)
- [ ] Clipboard monitoring captures text changes
- [ ] Encryption using AES-256-GCM with unique nonces
- [ ] Master key stored in Keychain
- [ ] Global hotkey (Cmd+Shift+V) works
- [ ] Popup window shows encrypted history
- [ ] Can paste selected items
- [ ] Memory zeroing implemented
- [ ] No plaintext logging
- [ ] Manual testing complete
- [ ] Code signed and verified

---

## Known Limitations (Document for Users)

1. **No Persistence** - History cleared on app quit (in-memory only)
2. **Plain Text Only** - Images, files, rich text not supported
3. **No Authentication** - No Touch ID/Face ID in v0.1
4. **Memory Exposure** - Decrypted text exists briefly for UI
5. **Fixed Hotkey** - Cmd+Shift+V not customizable
6. **No Search** - Basic list view only
7. **No App Exclusions** - Captures from all apps

## Next Steps (v0.2+)

1. Persistent storage (encrypted SQLite)
2. Per-item encryption keys
3. Touch ID authentication
4. Data classification (passwords, API keys)
5. Screen recording protection
6. Customizable hotkeys
7. App exclusion rules

---

**Implementation Complete!** ðŸŽ‰
